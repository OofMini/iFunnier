name: iFunnier Debug (FLEX Only)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to iFunny IPA'
        required: true

jobs:
  inject_flex:
    name: Inject FLEX Only
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # Cyan (pyzule) needs ldid for signing and python
          brew install ldid wget
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Download Files (IPA & libFLEX)
        run: |
          # 1. Download User IPA
          wget "${{ inputs.ipa_url }}" --no-verbose -O ${{ github.workspace }}/ifunny.ipa

          # 2. Download libFLEX.dylib
          # Using the standard pre-compiled library
          wget "https://github.com/oa414/libFLEX/raw/master/libFLEX.dylib" --no-verbose -O ${{ github.workspace }}/libFLEX.dylib

          # Verify File Types
          file_type=$(file --mime-type -b ${{ github.workspace }}/ifunny.ipa)
          if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" && "$file_type" != "application/octet-stream" ]]; then
            echo "::error::Validation failed: The downloaded IPA is invalid. Detected type: $file_type"
            exit 1
          fi

      - name: Inject FLEX (Cyan)
        run: |
          # Injecting ONLY libFLEX.dylib. 
          # The main 'iFunnier.deb' is intentionally excluded.
          cyan -i ${{ github.workspace }}/ifunny.ipa \
               -o ${{ github.workspace }}/iFunnier_FLEX_Only.ipa \
               -f ${{ github.workspace }}/libFLEX.dylib

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: flex-debug-v${{ github.run_number }}
          name: iFunnier FLEX (No Tweak) ${{ github.run_number }}
          files: ${{ github.workspace }}/iFunnier_FLEX_Only.ipa
          draft: true
