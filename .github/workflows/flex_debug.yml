name: iFunnier Debug (FLEX Only)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: 'Direct URL to DECRYPTED iFunny IPA'
        required: true

jobs:
  inject_flex:
    name: Inject FLEXall
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install ldid wget
          pipx install --force https://github.com/asdfzxcvbn/pyzule-rw/archive/main.zip

      - name: Download Files
        run: |
          # 1. Download User IPA
          wget "${{ inputs.ipa_url }}" --no-verbose -O ${{ github.workspace }}/ifunny.ipa

          # 2. Download FLEXall (.deb)
          # We use a known working version of FLEXall which is more stable than raw libFLEX
          wget "https://github.com/dgh0st/FLEXall/raw/master/packages/com.dgh0st.flexall_0.0.1-24_iphoneos-arm.deb" --no-verbose -O ${{ github.workspace }}/FLEXall.deb || \
          wget "https://github.com/NSExceptional/FLEXing/releases/download/1.2/com.pantsthief.flexing_1.2_iphoneos-arm.deb" --no-verbose -O ${{ github.workspace }}/FLEXall.deb

          # Verify IPA
          file_type=$(file --mime-type -b ${{ github.workspace }}/ifunny.ipa)
          if [[ "$file_type" != "application/x-ios-app" && "$file_type" != "application/zip" && "$file_type" != "application/octet-stream" ]]; then
            echo "::error::Validation failed: The downloaded file is not a valid IPA."
            exit 1
          fi

      - name: Inject FLEX (Cyan)
        run: |
          # Inject the .deb directly. Cyan handles extracting the dylib and merging the plist.
          cyan -i ${{ github.workspace }}/ifunny.ipa \
               -o ${{ github.workspace }}/iFunnier_FLEX.ipa \
               -f ${{ github.workspace }}/FLEXall.deb

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: flex-debug-v${{ github.run_number }}
          name: iFunnier FLEX Debug ${{ github.run_number }}
          files: ${{ github.workspace }}/iFunnier_FLEX.ipa
          draft: true
